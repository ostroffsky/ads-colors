<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Тест</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>

    <style>
        .item-img img {
            width: 450px;
            border-radius: 20px;
            }

        .color {
            width: 50px;
            margin: 5px;
            padding: 8px 5px;
            text-align: center;
            color: #fff;
            border-radius: 10px;
            }

        .item-img-w {
            position: relative;
            background: grey;
            padding-bottom: 40px;
            border-radius: 20px;
            overflow: hidden;
            }

        .item-img-w:after {
            content: 'Узнать подробнее';
            position: absolute;
            margin-top: 10px;
            bottom: 14px;
            left: 20px;
            color: white;
            }
    </style>

    <script>
        window.onload = function () {
            calculateColors();
        };
    </script>
</head>
<body>

<table>
    <tr class="item">
        <td class="item-img">
            <div class="item-img-w">
                <img src="1.jpg" alt="1"/>
            </div>
        </td>
        <td class="item-img">
            <div class="item-img-w">
                <img src="1.jpg" alt="1"/>
            </div>
        </td>
        <td class="item-result"></td>
        <td class="item-accent"></td>
    </tr>
    <tr class="item">
        <td class="item-img">
            <div class="item-img-w"><img src="2.jpg" alt="1"/></div>
        </td>
        <td class="item-img">
            <div class="item-img-w"><img src="2.jpg" alt="1"/></div>
        </td>
        <td class="item-result"></td>
        <td class="item-accent"></td>
    </tr>
    <tr class="item">
        <td class="item-img">
            <div class="item-img-w"><img src="3.jpg" alt="1"/></div>
        </td>
        <td class="item-img">
            <div class="item-img-w"><img src="3.jpg" alt="1"/></div>
        </td>
        <td class="item-result"></td>
        <td class="item-accent"></td>
    </tr>
    <tr class="item">
        <td class="item-img">
            <div class="item-img-w"><img src="4.jpg" alt="1"/></div>
        </td>
        <td class="item-img">
            <div class="item-img-w"><img src="4.jpg" alt="1"/></div>
        </td>
        <td class="item-result"></td>
        <td class="item-accent"></td>
    </tr>
    <tr class="item">
        <td class="item-img">
            <div class="item-img-w"><img src="5.jpg" alt="1"/></div>
        </td>
        <td class="item-img">
            <div class="item-img-w"><img src="5.jpg" alt="1"/></div>
        </td>
        <td class="item-result"></td>
        <td class="item-accent"></td>
    </tr>
    <tr class="item">
        <td class="item-img">
            <div class="item-img-w"><img src="6.jpg" alt="1"/></div>
        </td>
        <td class="item-img">
            <div class="item-img-w"><img src="6.jpg" alt="1"/></div>
        </td>
        <td class="item-result"></td>
        <td class="item-accent"></td>
    </tr>
    <tr class="item">
        <td class="item-img">
            <div class="item-img-w"><img src="7.jpg" alt="1"/></div>
        </td>
        <td class="item-img">
            <div class="item-img-w"><img src="7.jpg" alt="1"/></div>
        </td>
        <td class="item-result"></td>
        <td class="item-accent"></td>
    </tr>
    <tr class="item">
        <td class="item-img">
            <div class="item-img-w"><img src="8.jpg" alt="1"/></div>
        </td>
        <td class="item-img">
            <div class="item-img-w"><img src="8.jpg" alt="1"/></div>
        </td>
        <td class="item-result"></td>
        <td class="item-accent"></td>
    </tr>
    <tr class="item">
        <td class="item-img">
            <div class="item-img-w"><img src="9.jpg" alt="1"/></div>
        </td>
        <td class="item-img">
            <div class="item-img-w"><img src="9.jpg" alt="1"/></div>
        </td>
        <td class="item-result"></td>
        <td class="item-accent"></td>
    </tr>
    <tr class="item">
        <td class="item-img">
            <div class="item-img-w"><img src="10.jpg" alt="1"/></div>
        </td>
        <td class="item-img">
            <div class="item-img-w"><img src="10.jpg" alt="1"/></div>
        </td>
        <td class="item-result"></td>
        <td class="item-accent"></td>
    </tr>
</table>

<script>
    var calculateColors = function () {
        const colorThief = new ColorThief();

        const items = document.querySelectorAll('.item');
        items.forEach(value => {
            console.log(value);

            const img = value.querySelector('img');
            console.log(img);

            // Make sure image is finished loading
            var color = [0, 0, 0];
            var palette = [];
            if (img.complete) {
                color = colorThief.getColor(img);
                palette = colorThief.getPalette(img, 10);
            } else {
                img.addEventListener('load', function () {
                    color = colorThief.getColor(img);
                    palette = colorThief.getPalette(img, 10);
                });
                img.addEventListener('error', function () {
                    alert('error')
                });
            }

            console.log(color);
            console.log(palette);

            value.querySelector(".item-result").setAttribute("style", "background: " + getRgbFromArray(color) + ";");
            value.querySelector(".item-result").appendChild(createColor(color, "Средний цвет"));

            palette.forEach(c => {
                value.querySelector(".item-result").appendChild(createColor(c, "Текст"));
            });

            let accent = findAccentColor(palette);
            value.querySelector(".item-accent").appendChild(createColor(accent, "Акцент"));
            //value.querySelector(".item-accent").appendChild(createColor(increaseContrast(accent, 0.8)));

            value.querySelector(".item-img-w").setAttribute("style", "background: " + getRgbFromArray(color) + ";");
            value.querySelector(".item-img:nth-child(2) .item-img-w").setAttribute("style", "background: " + getRgbFromArray(accent) + ";");
        });
    }

    function getRgb(r, g, b) {
        return "rgb(" + r + "," + g + "," + b + ")";
    }

    function getRgbFromArray(rgbArr) {
        return getRgb(rgbArr[0], rgbArr[1], rgbArr[2]);
    }

    function normalizeColor(rgbArray) {
        const [r, g, b] = rgbArray;
        const maxVal = Math.max(r, g, b);
        if (maxVal === 0) return [0, 0, 0]; // Чтобы избежать деления на ноль

        const factor = 255 / maxVal;
        return [
            Math.min(255, Math.max(0, r * factor)),
            Math.min(255, Math.max(0, g * factor)),
            Math.min(255, Math.max(0, b * factor))
        ];
    }

    function getContrastColor(rgbArray) {
        const [r, g, b] = rgbArray;
        const luminance = calculateLuminance(r, g, b);
        return luminance > 128 ? [0, 0, 0] : [255, 255, 255]; // Черный или белый
    }

    function increaseContrast(rgbArray, factor = 1.5) {
        const [r, g, b] = rgbArray;
        return [
            Math.min(255, Math.max(0, r * factor)), // Ограничиваем значения в диапазоне [0, 255]
            Math.min(255, Math.max(0, g * factor)),
            Math.min(255, Math.max(0, b * factor))
        ];
    }

    const color = [100, 150, 200];
    const contrastedColor = increaseContrast(...color, 1.5);
    console.log("Увеличенная контрастность:", contrastedColor); // [150, 225, 255]


    function createColor(rgbArr, text) {
        var div = document.createElement("div");
        div.setAttribute("class", "color");
        div.setAttribute("style", "background: " + getRgbFromArray(rgbArr) + ";");
        div.textContent = text;

        return div;
    }


    // Функция для расчета яркости
    function calculateLuminance(r, g, b) {
        return 0.299 * r + 0.587 * g + 0.114 * b;
    }

    // Функция для расчета насыщенности
    function calculateSaturation(r, g, b) {
        const maxVal = Math.max(r, g, b);
        const minVal = Math.min(r, g, b);
        return (maxVal - minVal) / maxVal || 0; // Избегаем деления на ноль
    }

    // Функция для расчета контраста между двумя цветами
    function calculateContrast(l1, l2) {
        return (l1 + 0.05) / (l2 + 0.05);
    }

    // Функция для поиска самого акцентного цвета
    function findAccentColor(colors) {
        let maxAccentScore = -1;
        let accentColor = null;

        // Перебираем все цвета
        colors.forEach((color, index) => {
            const [r, g, b] = color;
            const luminance = calculateLuminance(r, g, b);
            const saturation = calculateSaturation(r, g, b);

            // Рассчитываем контрастность относительно других цветов
            let maxContrast = 0;
            colors.forEach((otherColor, otherIndex) => {
                if (index !== otherIndex) {
                    const otherLuminance = calculateLuminance(...otherColor);
                    const contrast = calculateContrast(luminance, otherLuminance);
                    if (contrast > maxContrast) {
                        maxContrast = contrast;
                    }
                }
            });

            // Рассчитываем общий акцентный показатель
            const accentScore = luminance * saturation * maxContrast;

            // Обновляем самый акцентный цвет
            if (accentScore > maxAccentScore) {
                maxAccentScore = accentScore;
                accentColor = color;
            }
        });

        return accentColor;
    }

</script>


</body>
</html>